# 仕様書

## 1. 概要
* **ドキュメント名**：仕様書
* **対象機能**：F-003 AI 入力オーケストレーション
* **対応する機能要件**：機能要件定義書 F-003、機能詳細 3.3
* **担当者**：バックオフィス CA 担当（利用）、AI チーム（実装）
* **前提条件**：
  - CA_NOTICE・S-001 情報が揃っている
  - ユーザーはテンプレ選択権限を持つ
* **制約条件**：
  - 原文テキスト最大 10,000 文字
  - 顧客セグメント設定はマスタ値のみ

---

## 2. 画面仕様

### 2.1 画面概要
* **画面ID**：UI-CA-002
* **画面名称**：AI 入力設定
* **利用者ロール**：CA 担当（オペレーター）

### 2.2 画面レイアウト
```
[案件ヘッダー]
  - CA通知ID / 銘柄 / CA種別 / 権利確定日
[原文表示パネル]
[入力設定パネル]
  - テンプレ種別（個人/法人等）
  - 顧客セグメント
  - 敬称/トーン
  - 追加指示（テキスト）
[アクションバー]
  - AI生成ボタン / キャンセル
```

### 2.3 画面項目
| 項目ID | 項目名 | 型 | 必須 | 初期値 | 備考 |
| -- | -- | -- | -- | -- | -- |
| ITM-101 | テンプレ種別 | select | ○ | 個人一般 | |
| ITM-102 | 顧客セグメント | select | ○ | 国内個人 | |
| ITM-103 | 敬称設定 | select | ○ | 「お客さま」 | |
| ITM-104 | 表現トーン | select | ○ | 丁寧（敬体） | |
| ITM-105 | 追加指示 | textarea | - | 空 | 500文字 |
| ITM-106 | 原文テキスト | textarea | - | F-001 | 読み取り専用 |

### 2.4 ボタン／アクション
| アクションID | 名称 | 概要 |
| -- | -- | -- |
| ACT-101 | AI生成 | 入力値＋原文を組み合わせ、S-002 へ送信 |
| ACT-102 | キャンセル | P-003 を終了し一覧へ戻る |

### 2.5 エラーメッセージ
| No | メッセージ | 条件 |
| -- | -- | -- |
| ERR-101 | 原文テキストが長すぎます（10,000 文字以内）。 | ITM-106 > 10,000 |
| ERR-102 | テンプレ種別を選択してください。 | ITM-101 未選択 |
| ERR-103 | S-002 への送信に失敗しました。 | API エラー |

---

## 3. 処理仕様

### 3.1 処理概要
```
1. 入力チェック（テンプレ/セグメント等）
2. 原文テキスト前処理（改行整理、HTML 除去）
3. ペイロード JSON 組立
4. AI エージェント API 呼出
5. 応答メタ情報の記録（AI_REQUEST、AI_OUTPUT）
```

### 3.2 処理詳細
| 手順 | 内容 | 入力 | 出力 |
| -- | -- | -- | -- |
| 1 | Validation | UI 値 | OK/NG |
| 2 | 原文整形 | notice_text | cleaned_text |
| 3 | JSON 組立 | cleaned_text, parameters | prompt_json |
| 4 | API 呼出 | prompt_json | response |
| 5 | DB 登録 | response | AI_REQUEST/OUTPUT |

### 3.3 業務ルール
* 顧客セグメントが「法人」の場合は敬称固定「各位」
* 追加指示内で禁止語（例：XX）を検知した場合は警告

### 3.4 例外処理
* 原文が OCR 未済でテキスト空 → エラー通知し取込画面へ遷移
* API タイムアウト → 再送信ボタン有効化

---

## 4. API / 外部連携

### 4.1 API一覧
| API ID | 名称 | IF種別 | 呼び出し方向 |
| -- | -- | -- | -- |
| API-003 | AI 要約生成 API | REST | 本システム→S-002 |

### 4.2 リクエスト
```
POST /poc/ai/v1/summary
```
```json
{
  "noticeId": "CA-20250331-001",
  "templateType": "retail_individual",
  "customerSegment": "domestic_individual",
  "prompt": "...",
  "meta": {
    "tone": "polite",
    "honorific": "お客さま"
  }
}
```

### 4.3 レスポンス
```json
{
  "internalSummary": "...",
  "customerDraft": "...",
  "modelVersion": "v1.2",
  "generatedAt": "2025-11-18T02:00:00Z"
}
```

### 4.4 エラー
| コード | 内容 | 対処 |
| -- | -- | -- |
| 422 | 入力文長過多 | 原文分割案内 |
| 429 | 呼出過多 | 再試行待ち |
| 500 | AI 障害 | システム管理者連絡 |

---

## 5. データ仕様

### 5.1 データ項目
| No | 論理名 | 物理名 | 備考 |
| -- | -- | -- | -- |
| D-006 | 原文テキスト | notice_text | CA_NOTICE |
| D-007 | 社内要約 | internal_summary | AI_OUTPUT |
| D-008 | 顧客向けドラフト | customer_draft | AI_OUTPUT |
| D-009 | バージョン番号 | version_no | DRAFT_VERSION |

### 5.2 テーブル
* **AI_REQUEST**：prompt_json, template_type 等
* **AI_OUTPUT**：生成結果格納

---

## 6. シーケンス図
```
ユーザー → UI-CA-002 → Backend → S-002
1. 入力送信
2. Validation & JSON 組立
3. AI API 呼出
4. 生成結果保存
5. UI-CA-003 へ遷移
```

