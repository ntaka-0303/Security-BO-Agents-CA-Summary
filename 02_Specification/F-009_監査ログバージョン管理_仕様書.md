# 仕様書

## 1. 概要
* **ドキュメント名**：仕様書
* **対象機能**：F-009 監査ログ／バージョン管理
* **対応する機能要件**：機能要件定義書 F-009、機能詳細 3.9
* **担当者**：コンプライアンス・システム管理チーム
* **前提条件**：全機能からアクションイベントを受信できる
* **制約条件**：改ざん防止ストレージ（Write Once）、保管期間 7 年

---

## 2. 画面仕様
管理者 UI（UI-CA-ADM）でログ照会。簡易仕様:
* フィルタ（期間/ユーザー/エンティティ）
* ログ一覧（timestamp、entity、action、user）
* 詳細表示（payload ハッシュ、差分）

---

## 3. 処理仕様

### 3.1 処理概要
```
1. 各機能からイベントを受信
2. 標準フォーマットへ整形（JSON）
3. ハッシュ生成＋署名
4. AUDIT_LOG テーブルへ書き込み
5. 週次でアーカイブストレージへ転送
```

### 3.2 処理詳細
| 手順 | 内容 | 入力 | 出力 |
| -- | -- | -- | -- |
| 1 | イベント受信 | event payload | normalized event |
| 2 | 署名 | normalized event | payload_digest |
| 3 | DB 登録 | normalized event | AUDIT_LOG |
| 4 | WORM 書込 | normalized event | archive object |
| 5 | エクスポート | 検索条件 | CSV |

### 3.3 業務ルール
* 各イベントに一意の audit_id（UUID）
* F-005/F-007 操作時は差分情報を payload_digest に含める
* 監査画面で抽出したデータは 30 日で自動削除（キャッシュ）

### 3.4 例外処理
* DB 書込失敗→即時リトライ、失敗継続でアラート
* アーカイブ失敗→再試行ジョブをスケジュール

---

## 4. API / 外部連携
* Syslog で SIEM へ送信（TCP/TLS）
* 形式：`<timestamp> CA-AUDIT entity=CA_NOTICE action=UPDATE user=bo001`

---

## 5. データ仕様
### 5.1 項目
| 論理名 | 物理名 | 型 | NULL | 説明 |
| -- | -- | -- | -- | -- |
| 監査ID | audit_id | varchar(64) | NOT NULL | 主キー |
| 対象種別 | entity_type | varchar(32) | NOT NULL | NOTICE/DRAFT 等 |
| 対象ID | entity_id | varchar(64) | NOT NULL | |
| 操作種別 | action | varchar(32) | NOT NULL | CREATE/UPDATE 等 |
| 操作者 | performed_by | varchar(64) | NOT NULL | ユーザー or システム |
| 実施日時 | performed_at | timestamp | NOT NULL | |
| 変更サマリ | payload_digest | varchar(256) | NOT NULL | SHA-256 等 |

### 5.2 テーブル
* **AUDIT_LOG**（上記項目）

---

## 6. シーケンス図
```
任意機能 → 監査イベントAPI → Audit Service
  → DB (AUDIT_LOG) → WORM Storage → SIEM
```

