# 仕様書

## 1. 概要
* **ドキュメント名**：仕様書
* **対象機能**：F-004 要約・ドラフト生成エージェント
* **対応する機能要件**：機能要件定義書 F-004、機能詳細 3.4
* **担当者**：AI エージェント基盤チーム
* **前提条件**：F-003 より正規化されたプロンプトを受領済み
* **制約条件**：LLM サービス使用、禁止語フィルタ必須

---

## 2. 画面仕様
UI なし（バックエンド処理）

---

## 3. 処理仕様

### 3.1 処理概要
```
1. 受信ペイロード検証
2. LLM 推論実行（要約＋顧客ドラフト）
3. 出力フォーマット整形（敬体、箇条書き）
4. 禁止語フィルタリング・リスクトークン抽出
5. AI_OUTPUT テーブルへ保存
```

### 3.2 処理詳細
| 手順 | 処理内容 | 入力 | 出力 |
| -- | -- | -- | -- |
| 1 | Schema validation | prompt_json | validated_payload |
| 2 | LLM 推論 | validated_payload | raw_output |
| 3 | フォーマット整形 | raw_output | structured_output |
| 4 | フィルタ | structured_output | filtered_output + risk_tokens |
| 5 | DB 保存 | filtered_output | AI_OUTPUT レコード |

### 3.3 業務ルール
* 社内要約：イベント種別、銘柄、重要日付を含む
* 顧客ドラフト：導入文＋箇条書き（基準日、配当金、支払日、注意事項）
* フィルタリングで NG ワード検知時は `risk_tokens` に記録

### 3.4 例外処理
* LLM サービス ERROR → リトライ 2 回、失敗時に F-003 へエラー返却
* フィルタリングで致命的判定 → 出力保存せずアラート

---

## 4. API / 外部連携

### 4.1 API一覧
| API ID | 名称 | IF種別 | 呼び出し方向 |
| -- | -- | -- | -- |
| API-004 | LLM 推論 API | REST/Streaming | 本システム→AI モデル |

### 4.2 リクエスト例
```json
{
  "model": "ca-summary-v1",
  "prompt": "...",
  "temperature": 0.2,
  "maxTokens": 1024
}
```

### 4.3 レスポンス例
```json
{
  "choices": [
    {
      "summary": "○○株式会社…",
      "customerDraft": "お客さま…"
    }
  ],
  "usage": {
    "promptTokens": 800,
    "completionTokens": 450
  }
}
```

### 4.4 エラー
| コード | 内容 | 対処 |
| -- | -- | -- |
| 503 | モデル利用不可 | 再試行 |
| 429 | レート制限 | 待機後リトライ |

---

## 5. データ仕様

### 5.1 データ項目
| No | 論理名 | 物理名 | 説明 |
| -- | -- | -- | -- |
| D-007 | 社内要約 | internal_summary | text |
| D-008 | 顧客向けドラフト | customer_draft | text |
| D-010 | リスク判定フラグ | risk_flag | draft 側に利用 |

### 5.2 テーブル
* **AI_OUTPUT**（ai_output_id, ai_request_id, internal_summary, customer_draft, model_version, risk_tokens, generated_at）

---

## 6. シーケンス図
```
F-003 → F-004 → AIモデル → F-004 → DB
```

