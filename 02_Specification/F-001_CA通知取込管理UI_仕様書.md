# 仕様書

## 1. 概要

* **ドキュメント名**：仕様書
* **対象機能**：F-001 CA通知取込管理 UI
* **対応する機能要件**：機能要件定義書_CA_summary_agent.md 該当行（F-001）、機能詳細書 3.1
* **担当者**：バックオフィス CA 担当（業務）、システム部 UI チーム
* **前提条件**：
  - CA 通知原文が PDF/メール等で取得済み
  - 利用者は社内認証を通過し当該案件へのアクセス権を保有
* **制約条件**：
  - 添付ファイルは 20MB 以下かつ 5 件まで
  - PoC 環境でのみ運用（本番データ不可）

---

## 2. 画面仕様（UI仕様）

### 2.1 画面概要
* **画面ID**：UI-CA-001
* **画面名称**：CA通知取込管理
* **利用者ロール**：バックオフィス CA 担当

### 2.2 画面レイアウト
```
[フィルタ領域]
  - 銘柄コード | CA種別 | 状態 | 検索ボタン
[新規取込フォーム]
  - 銘柄コード / 銘柄名 / CA種別 / 権利確定日 / 支払開始日
  - CA原文ファイル添付エリア（複数）
  - 重要メモ
[案件一覧グリッド]
  - CA通知ID | 銘柄 | 種別 | 状態 | 作成日時 | 詳細ボタン
```

### 2.3 画面項目一覧
| 項目ID | 項目名 | 型 | 必須 | 初期値 | 入力制御 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| ITM-001 | 銘柄コード | text | ○ | 空 | 数字＋英字、最大10桁 | |
| ITM-002 | 銘柄名 | text | ○ | 空 | 全角可、120桁 | |
| ITM-003 | CA種別 | select | ○ | 普通配当 | マスタ値 | |
| ITM-004 | 権利確定日 | date | ○ | 今日 | 過去日可 | |
| ITM-005 | 支払開始日 | date | - | 空 | 未来日許容 | |
| ITM-006 | CA原文ファイル | file (multi) | ○ | - | PDF/MSG/TXT | 20MB×5 |
| ITM-007 | 重要メモ | textarea | - | 空 | 1000文字 | |
| GRID-001 | CA通知一覧 | table | - | - | 並替/フィルタ | 取込済データ |

### 2.4 ボタン／アクション
| アクションID | アクション名 | 処理概要 |
| -- | -- | -- |
| ACT-001 | 取込 | 入力チェック→案件登録→S-001 参照 |
| ACT-002 | 下書き保存 | 最小項目のみ保存、状態=Draft |
| ACT-003 | 検索 | フィルタ条件で案件一覧再取得 |
| ACT-004 | 添付ダウンロード | 選択行の添付ファイルを取得 |

### 2.5 エラーメッセージ
| No | メッセージ | 表示条件 |
| -- | -- | -- |
| ERR-001 | 銘柄コードを入力してください。 | ITM-001 未入力で取込 |
| ERR-002 | CA原文ファイル形式が不正です。 | 許可外拡張子 |
| ERR-003 | 添付ファイルは5件以内で指定してください。 | 6件以上添付 |
| ERR-004 | S-001 との連携に失敗しました。再試行してください。 | API エラー |
| WRN-001 | 同一 CA通知ID が既に存在します。 | 重複検知 |

---

## 3. 処理仕様

### 3.1 処理概要フロー
```
1. 入力チェック（必須・型・サイズ）
2. 重複チェック（銘柄コード＋権利確定日＋種別）
3. 添付ファイルウイルススキャン
4. CA_NOTICE へ登録
5. S-001 へ案件照会（存在時は案件情報反映）
6. 取込結果を画面へ返却
```

### 3.2 処理詳細
| 手順 | 処理内容 | 入力 | 出力 | 備考 |
| -- | -- | -- | -- | -- |
| 1 | 入力チェック | 画面入力 | チェック結果 | 必須/型/桁数 |
| 2 | 重複判定 | 銘柄コード等 | true/false | 既存 CA_NOTICE |
| 3 | ファイルスキャン | 添付ファイル | OK/NG | セキュリティAPI |
| 4 | 案件登録 | 入力値 | CA_NOTICE | 状態=“intake” |
| 5 | 外部連携 | CA通知ID | S-001 応答 | F-002 へ渡す |
| 6 | 応答作成 | 登録結果 | 画面表示 | 成功/失敗メッセージ |

### 3.3 業務ルール
* CA通知ID は日付＋連番で自動採番
* 銘柄コードは必ず CA 管理マスタと一致させる（不一致は警告）
* 添付ファイルは削除できない（差替時は再取込）

### 3.4 例外処理
* 入力エラー：エラーメッセージ表示し保存不可
* ウイルス検知：登録中止しセキュリティチーム通知
* 連携タイムアウト：ローカル保存し「再連携」アクションを提示

---

## 4. API / 外部システム連携

### 4.1 API一覧
| API ID | API名称 | IF種別 | 呼び出し方向 |
| -- | -- | -- | -- |
| API-001 | CA案件照会 API (S-001) | REST | 本システム→S-001 |

### 4.2 リクエスト仕様
```
POST /poc/ca/v1/notices/lookup
Content-Type: application/json
```
```json
{
  "securityCode": "1234",
  "eventType": "DIVIDEND",
  "recordDate": "2025-03-31"
}
```

### 4.3 レスポンス仕様
```json
{
  "exists": true,
  "noticeId": "CA-20250331-001",
  "paymentDate": "2025-06-01"
}
```

### 4.4 エラー仕様
| エラーコード | 内容 | 対処 |
| -- | -- | -- |
| 400 | リクエスト形式不正 | 入力再確認 |
| 404 | 案件未登録 | 画面で警告のみ |
| 500 | 外部システム障害 | リトライ or 手動入力 |

---

## 5. データ仕様

### 5.1 データ項目
| No | 論理名 | 物理名 | 型 | 桁数 | NULL | 説明 |
| -- | -- | -- | -- | -- | -- | -- |
| D-001 | CA通知ID | ca_notice_id | varchar | 64 | NOT NULL | 主キー |
| D-002 | 銘柄コード | security_code | varchar | 10 | NOT NULL | |
| D-003 | CA種別 | ca_event_type | varchar | 32 | NOT NULL | |
| D-004 | 権利確定日 | record_date | date | - | NOT NULL | |
| D-005 | 支払開始日 | payment_date | date | - | NULL | |
| D-006 | 原文テキスト | notice_text | text | - | NOT NULL | |

### 5.2 テーブル定義
* **テーブル名**：CA_NOTICE
* **主キー**：ca_notice_id
* **カラム定義**：テーブル定義書参照（CA_NOTICE セクション）

---

## 6. シーケンス図（概要）
```
ユーザー → UI-CA-001 → バックエンド → S-001
1. 取込要求送信
2. バリデーション & 登録
3. 案件照会 API 呼出
4. 結果を UI に返却
``` 

