# 仕様書

## 1. 概要
* **ドキュメント名**：仕様書
* **対象機能**：F-007 上長承認ワークフロー連携
* **対応する機能要件**：機能要件定義書 F-007、機能詳細 3.7
* **担当者**：品質管理部、ワークフロー開発チーム
* **前提条件**：F-005 で承認依頼が発生し draft_version が確定
* **制約条件**：承認期限 24h、差戻し時コメント必須

---

## 2. 画面仕様

### 2.1 画面概要
* **画面ID**：UI-CA-004
* **画面名称**：承認ダッシュボード
* **利用者ロール**：上長／品質管理者

### 2.2 画面レイアウト
```
[検索条件] 状態/リスク/銘柄
[案件リスト] ドラフトID, 銘柄, リスク, 更新日時
[詳細ペイン] AI要約, ドラフト, 修正履歴, リスク理由
[承認操作] 承認, 差戻し, コメント欄
```

### 2.3 画面項目
| 項目ID | 項目名 | 型 | 必須 | 備考 |
| -- | -- | -- | -- | -- |
| ITM-301 | 承認コメント | textarea | 差戻し時必須 | 500文字 |
| ITM-302 | 承認ステータス | radio | ○ | approved/rejected |
| ITM-303 | 添付プレビュー | link | - | PDF 表示 |

### 2.4 ボタン／アクション
| ID | 名称 | 概要 |
| -- | -- | -- |
| ACT-301 | 承認 | approval_status=approved、ワークフロー完了 |
| ACT-302 | 差戻し | コメント必須、担当者へ通知 |
| ACT-303 | 再承認依頼 | 差戻し後、担当者から送信可 |
| ACT-304 | PDF プレビュー | F-005 から生成した PDF 表示 |

### 2.5 エラーメッセージ
| No | メッセージ | 条件 |
| -- | -- | -- |
| ERR-301 | 差戻しコメントを入力してください。 | 差戻し選択でコメント空 |
| ERR-302 | 承認対象が存在しません。 | リスト未選択 |
| ERR-303 | ワークフローAPIエラー | 外部連携失敗 |

---

## 3. 処理仕様

### 3.1 処理概要
```
1. 承認キューから対象取得
2. 承認者へ通知（メール/Slack）
3. 承認操作→DRAFT_VERSION 更新
4. APPROVAL_HISTORY へ履歴保存
5. 承認結果を F-008 へ連携
```

### 3.2 処理詳細
| 手順 | 内容 | 入力 | 出力 |
| -- | -- | -- | -- |
| 1 | キュー取得 | risk_flag=Y or pending approval | 案件リスト |
| 2 | UI 表示 | draft_id | 表示データ |
| 3 | 承認/差戻し処理 | 操作内容 | DRAFT_VERSION 更新 |
| 4 | 履歴保存 | 操作内容 | APPROVAL_HISTORY |
| 5 | 通知 | 状態変化 | メール/Slack |

### 3.3 業務ルール
* リスクフラグ Y は承認必須
* 承認期限 24h 過ぎると再通知
* 差戻し後、担当者が再提出しない場合 48h でエスカレーション

### 3.4 例外処理
* ワークフロー API ダウン → ローカルキュー保持し再送
* 承認者不在 → 代理承認者に自動割当

---

## 4. API / 外部連携

### 4.1 API一覧
| API ID | 名称 | IF種別 | 呼び出し方向 |
| -- | -- | -- | -- |
| API-007 | 承認ワークフロー API (S-004想定) | REST | 双方向 |

### 4.2 リクエスト例
```json
{
  "draftId": 102,
  "action": "approve",
  "approverId": "mgr001",
  "comment": "問題なし"
}
```

### 4.3 レスポンス例
```json
{
  "result": "accepted",
  "timestamp": "2025-11-18T02:30:00Z"
}
```

### 4.4 エラー仕様
| コード | 内容 | 対処 |
| -- | -- | -- |
| 409 | 既に処理済み | UI に最新状態再取得 |
| 500 | ワークフロー障害 | リトライ、保守連絡 |

---

## 5. データ仕様
### 5.1 項目
| 論理名 | 物理名 |
| -- | -- |
| 承認ID | approval_id |
| 承認者ID | approver_id |
| 判断 | decision |
| コメント | approval_comment |
| 承認日時 | decision_at |

### 5.2 テーブル
* **APPROVAL_HISTORY**
* **DRAFT_VERSION**（approval_status 更新）

---

## 6. シーケンス図
```
F-005 → 承認キュー → UI-CA-004 → Workflow API → DB → F-008
```

