# 仕様書

## 1. 概要
* **ドキュメント名**：仕様書
* **対象機能**：F-005 ドラフトレビュー UI
* **対応する機能要件**：機能要件定義書 F-005、機能詳細 3.5
* **担当者**：バックオフィス CA 担当（利用）、アプリ開発チーム（実装）
* **前提条件**：AI_OUTPUT が存在し、対象案件が取込済み
* **制約条件**：ブラウザ利用（Chrome）、編集ロック 15 分

---

## 2. 画面仕様

### 2.1 画面概要
* **画面ID**：UI-CA-003
* **画面名称**：ドラフトレビュー／修正
* **利用者ロール**：CA 担当、品質管理

### 2.2 画面レイアウト
```
[ヘッダー] CA通知ID / 銘柄 / 状態 / リスク表示
[左ペイン] 原文テキストビューア
[右ペイン上] AI 要約表示
[右ペイン中] 顧客ドラフト編集エリア (リッチテキスト)
[右ペイン下] コメント欄、確認チェック、差分パネル
[アクションバー] 保存 / 承認依頼 / 高リスク申告 / AIフィードバック
[バージョンタブ] バージョン一覧、差分比較
```

### 2.3 画面項目
| 項目ID | 項目名 | 型 | 必須 | 初期値 | 入力制御 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| ITM-201 | ドラフト本文 | rich text | ○ | F-004 | 文字数上限 4000 | |
| ITM-202 | コメント | textarea | - | 空 | 1000 文字 | |
| ITM-203 | 確認チェック | checkbox | ○ | OFF | 3 項目 | |
| ITM-204 | 高リスクフラグ | toggle | - | F-006 判定 | |
| LIST-201 | バージョン一覧 | table | - | 最新 | 選択で比較 |

### 2.4 ボタン／アクション
| ID | 名称 | 処理概要 |
| -- | -- | -- |
| ACT-201 | 保存 | DRAFT_VERSION 新規作成／更新 |
| ACT-202 | 承認依頼 | F-007 へデータ連携 |
| ACT-203 | 高リスク申告 | リスクフラグ ON + 承認必須設定 |
| ACT-204 | 差分表示 | 選択バージョン差分をモーダル表示 |
| ACT-205 | AI フィードバック | LLM 改善用フィード送信 |

### 2.5 エラーメッセージ
| No | メッセージ | 条件 |
| -- | -- | -- |
| ERR-201 | ドラフト本文が空です。 | ITM-201 空で保存 |
| ERR-202 | 確認チェックをすべて完了してください。 | ITM-203 未選択 |
| ERR-203 | 他ユーザーが編集中です。 | 編集ロック衝突 |
| ERR-204 | バージョン保存に失敗しました。 | DB エラー |

---

## 3. 処理仕様

### 3.1 処理概要
```
1. AI_OUTPUT／最新 DRAFT_VERSION の取得
2. 編集ロック取得（15 分）
3. 編集内容保存（diff 記録）
4. リスク判定結果反映
5. 承認依頼時は F-007 へキュー投入
```

### 3.2 処理詳細
| 手順 | 内容 | 入力 | 出力 |
| -- | -- | -- | -- |
| 1 | データロード | ca_notice_id | 表示用データ |
| 2 | 編集ロック | user_id | lock_token |
| 3 | バリデーション | draft_text | OK/NG |
| 4 | 保存 | draft_text 等 | DRAFT_VERSION |
| 5 | ログ生成 | 差分 | AUDIT_LOG |
| 6 | 承認依頼 | draft_id | 承認キュー |

### 3.3 業務ルール
* 保存時に version_no を自動 increment
* リスクフラグが ON なら必ず承認プロセスへ
* フィードバック送信時、AI_REQUEST のメタへ追記

### 3.4 例外処理
* ロック取得失敗→閲覧のみ許可
* 保存直後の障害→自動リカバリで draft_text を再表示

---

## 4. API / 外部連携

### 4.1 API一覧
| API ID | 名称 | 種別 | 呼び出し方向 |
| -- | -- | -- | -- |
| API-005 | Draft Save API | 内部 REST | UI→Backend |
| API-006 | Approval Queue API | REST | 本システム→ワークフロー |

### 4.2〜4.4
* 内部 API 仕様は機能詳細参照（JSON: draftText, comment, riskFlag 等）

---

## 5. データ仕様
### 5.1 データ項目
| No | 論理名 | 物理名 |
| -- | -- | -- |
| D-005 | 支払開始日 | payment_date |
| D-007 | 社内要約 | internal_summary |
| D-008 | 顧客ドラフト | customer_draft |
| D-009 | バージョン番号 | version_no |
| D-010 | リスク判定フラグ | risk_flag |
| D-011 | 承認ステータス | approval_status |

### 5.2 テーブル
* **DRAFT_VERSION**（編集内容）
* **AUDIT_LOG**（編集履歴）

---

## 6. シーケンス図
```
ユーザー → UI-CA-003 → Draft API → DB
    ↘ Approval Queue (when ACT-202)
```

