# 機能詳細書：CA 情報要約・通知文ドラフト生成エージェント

## 3. 機能詳細

### 3.1 機能名称：F-001 CA通知取込管理 UI

#### 3.1.1 対応プロセス
* 業務要件定義書：P-001（活動内容：発行体／情報ベンダーから CA 通知を受領し内容確認）

#### 3.1.2 利用者
* 部門：バックオフィス CA 担当
* ロール：CA 通知受付・一次確認担当

#### 3.1.3 入出力仕様
| 種別 | 名称 | 元データ/ファイル | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | CA 通知原文アップロード | F-001 | PDF/メール本文テキスト | 複数ファイル可 |
| 入力 | 銘柄基本情報手入力 | - | 画面入力 | S-001 未連携時に手入力 |
| 出力 | 取込案件レコード | F-002 | DBレコード | 案件ID付与、P-002へ連携 |

#### 3.1.4 画面仕様
* **画面ID**：UI-CA-001
* **画面項目一覧**

| 項目ID | 項目名 | 必須 | 型 | 最大桁数 | 入力制御 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| ITM-001 | CA通知ID | - | text | 64 | 自動採番 | 保存後表示 |
| ITM-002 | 銘柄コード | ○ | text | 10 | 数字＋英字 | 取込時に必須 |
| ITM-003 | 銘柄名 | ○ | text | 120 | 全角可 | |
| ITM-004 | CA種別 | ○ | select | - | プルダウン | 配当/分割 等 |
| ITM-005 | 権利確定日 | ○ | date | - | 日付入力 | |
| ITM-006 | CA原文ファイル | ○ | file | 20MB | PDF/MSG | 複数添付可 |
| ITM-007 | 重要メモ | - | textarea | 1000 | - | 任意 |

* **画面アクション**：取込、下書き保存、既存案件検索、削除（下書きのみ）、ダウンロード（添付）
* **エラー・警告メッセージ**
| No | メッセージ | 表示条件 |
| -- | -- | -- |
| ERR-001 | 銘柄コードを入力してください。 | ITM-002 未入力で保存時 |
| ERR-002 | CA原文ファイル形式が不正です。 | 許容拡張子以外を添付 |
| WRN-001 | 既に同一 CA通知ID の案件が存在します。 | 重複検知時（参考表示） |

#### 3.1.5 外部システム連携
| No | システム名 | 連携内容 | IF種別 | 呼び出し方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| IF-001 | S-001 CA 管理システム | 既存 CA 案件の検索・自動採番 | REST API | 本システム→S-001 | 随時 | 取込時 |

#### 3.1.6 業務ルール
* CA通知ID は自動採番し、同日同銘柄・同種別で重複がある場合は警告のみ。
* 添付ファイルは 20MB 未満、最大 5 点。

#### 3.1.7 例外処理
* S-001 接続不可：ローカルに下書き保存し、接続復旧後同期。
* ファイルウイルス検知：取込拒否しセキュリティ部門へ自動通知。

---

### 3.2 機能名称：F-002 CA管理システム連携 API

#### 3.2.1 対応プロセス
* P-002（CA 管理システムへ必要項目を登録）

#### 3.2.2 利用者
* 部門：システム部（バックエンド）
* ロール：連携バッチ／API サービス

#### 3.2.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | 取込案件レコード | F-002 | JSON | CA通知ID をキー |
| 出力 | 銘柄マスタ情報 | - | JSON | 銘柄名、コード、区分 |
| 出力 | 重要日付情報 | - | JSON | record_date, payment_date |

#### 3.2.4 画面仕様
* UI なし

#### 3.2.5 外部システム連携
| No | システム名 | 連携内容 | IF種別 | 呼び出し方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| IF-002 | S-001 CA 管理システム | 案件詳細取得 API 呼出し | REST API(JSON) | 本システム→S-001 | 随時 | タイムアウト 5s |

#### 3.2.6 業務ルール
* 銘柄コードが一致しない場合は手入力フラグを返す。
* 重要日付は営業日換算ロジックにより自動補正。

#### 3.2.7 例外処理
* API エラー時は 3 回リトライ後、担当者にアラートし手入力を促す。
* データ欠損時は UI 側へ警告表示し、未確定項目として扱う。

---

### 3.3 機能名称：F-003 AI 入力オーケストレーション

#### 3.3.1 対応プロセス
* P-003（AI エージェント画面へ原文・銘柄情報・条件を入力）

#### 3.3.2 利用者
* 部門：バックオフィス CA 担当
* ロール：AI 入力オペレーター

#### 3.3.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | CA 原文テキスト | F-001 | text | PDF から抽出 |
| 入力 | 銘柄・日付情報 | F-002 | JSON | S-001 経由 |
| 入力 | テンプレ条件・顧客セグメント | F-003 | JSON | UI 設定 |
| 出力 | AI リクエストペイロード | - | JSON | S-002 へ送信 |

#### 3.3.4 画面仕様
* UI：P-003 で使用する入力フォーム（UI-CA-002）
* 主な項目：テンプレート種別、顧客セグメント、敬称設定、表現トーン、自由記述指示。

#### 3.3.5 外部システム連携
| No | システム名 | 連携内容 | IF種別 | 呼び出し方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| IF-003 | S-002 AI エージェント基盤 | プロンプト生成・送信 | REST API | 本システム→S-002 | 随時 | 1件単位 |

#### 3.3.6 業務ルール
* 原文テキストは 10,000 文字以内。超過時は分割処理。
* 顧客セグメントに応じてテンプレートを自動切替（個人/法人）。
* 入力条件とシステム取得値に矛盾がある場合は確認ダイアログ表示。

#### 3.3.7 例外処理
* S-002 応答遅延（>8s）はプログレス表示継続、30s でタイムアウト。
* 入力 JSON 生成失敗時はローカルログに詳細出力し再送可能。

#### 3.3.8 追加 UI/UX 要件（AI 入力・実行モジュール）
* **一覧パネル**：CA通知ごとの AI 生成履歴をテーブル表示（最新 5 件）。列＝生成日時、テンプレート、顧客セグメント、リスクフラグ、ドラフトバージョン。
* **リクエスト作成フォーム**（UI-CA-002 内モーダル）：以下必須項目  
  - `template_type` (select)：standard / urgent / premium。デフォルト standard。  
  - `customer_segment` (radio)：retail / HNWI / institutional。  
  - `instructions` (textarea)：2000 文字上限。入力時にテンプレ変数のプレビューを右側カードで表示。  
* **AI 実行トリガー**：`生成` ボタン押下で `/api/ai/requests` を非同期呼び出し。処理中はスピナー＋「OpenAI 実行中…」ステータスチップを表示し、30 秒以内に応答がない場合はキャンセル可。
* **結果ハンドリング**：成功時に  
  - 内部要約・顧客ドラフトをサマリーカード表示  
  - リスクトークン一覧をタグ表示（危険語は赤）  
  - 「ドラフト詳細を開く」アクションで F-005 画面へ遷移し auto-save を開始
* **失敗時 UI**：API エラー本文をモーダル表示し、再試行／テキストベースの暫定ドラフト（ヒューリスティック）に切替可。

#### 3.3.9 画面コンポーネントおよびエンドポイント整理
| UIモジュール | Next.js ルート | 主コンポーネント | 呼び出す API | 備考 |
| -- | -- | -- | -- | -- |
| AI リクエストボード | `/ai` | `AiWorkbench`、`NoticeSelector`、`AiResultDrawer` | `GET /api/notices/`, `POST /api/ai/requests` | 通知選択＋AI実行。サーバ側ステータスに合わせてバッジ表示 |
| 生成履歴サイドバー | `/ai` | `AiHistoryList` | `GET /api/drafts/{notice_id}` | 直近ドラフトを取得し再編集に誘導 |
| リスクアラートチップ | `/ai` | `RiskTokenTags` | - （AI応答） | `risk_tokens` を色付きタグで表示 |

*UI では API エラーを `message.error`（赤）で即時表示し、監査ログ番号が返る場合はトーストに表示すること。*

---

### 3.4 機能名称：F-004 要約・ドラフト生成エージェント

#### 3.4.1 対応プロセス
* P-004（AI による要約・ドラフト生成）

#### 3.4.2 利用者
* 部門：AI エージェント基盤（システム）
* ロール：モデル推論サービス

#### 3.4.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | AI リクエストペイロード | F-003 | JSON | 原文＋指示 |
| 出力 | 社内向け要約 | F-004 | text | 1〜3 行 |
| 出力 | 顧客向け通知ドラフト | F-004 | text | 敬体、箇条書き付 |
| 出力 | メタ情報 | F-004 | JSON | バージョン、生成時刻、根拠 ID |

#### 3.4.4 画面仕様
* UI なし（P-005 で結果を表示）

#### 3.4.5 外部システム連携
| No | システム名 | 連携内容 | IF種別 | 呼び出し方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| IF-004 | S-002 | モデル推論 | REST API | 双方向 | 随時 | Streaming 応答可 |

#### 3.4.6 業務ルール
* 出力フォーマット：社内向け＝箇条書き + キー項目、顧客向け＝敬体テンプレ。
* 危険ワードフィルタリングを行い、検知時は警告フラグを付与。

#### 3.4.7 例外処理
* モデル応答不達：再試行（最大 2 回）後に担当者へエラー表示。
* 禁止語検知時はアウトプット生成を停止し、P-005 で手動対応。

---

### 3.5 機能名称：F-005 ドラフトレビュー UI

#### 3.5.1 対応プロセス
* P-005（AI 生成文をレビュー・修正）

#### 3.5.2 利用者
* 部門：バックオフィス CA 担当
* ロール：レビュー／修正担当者、品質管理者

#### 3.5.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | AI 生成結果 | F-004 | text/json | 要約、ドラフト、メタ情報 |
| 入力 | CA 原文参照 | F-001 | PDF/text | 画面で並置表示 |
| 出力 | 修正済みドラフト | F-005 | text | バージョン管理 |
| 出力 | コメント／差分ログ | F-005 | text | 監査ログへ連携 |

#### 3.5.4 画面仕様
* **画面ID**：UI-CA-003
* 主要項目：AI 要約欄、ドラフト編集エリア、変更履歴、コメント欄、リスクフラグ表示、バージョン一覧。
* アクション：保存、承認依頼、高リスク申告、差分表示、AI へフィードバック送信。
* エラー例：ERR-101「修正内容が空です」、ERR-102「バージョン競合が発生しました」。

#### 3.5.5 外部システム連携
* なし（内部 API のみ）

#### 3.5.6 業務ルール
* 保存時に最低 1 ヶ所の確認済チェックが必要。
* バージョン番号は保存ごとに自動 Increment。
* 高リスクフラグを ON にすると P-006 への承認依頼を強制。

#### 3.5.7 例外処理
* バージョン競合時は差分比較画面を提示し、再編集を促す。
* 編集中タイムアウト（15 分）で自動下書き保存。

#### 3.5.8 ドラフトレビュー UI 詳細要件
* **レイアウト**：左ペイン＝ドラフト一覧（最新順、ステータスバッジ付）、右ペイン＝原文ビュー＋編集エリア（タブ切替）。画面幅 1280px 基準で 40:60。
* **一覧フィルタ**：ステータス（draft/pending/approved/rejected）、リスクフラグ（Y/N）、担当者で絞り込み。プリセット「要対応」「承認待ち」。
* **編集エリア**：  
  - リッチテキストサポート（箇条書き、太字）  
  - 変更差分表示（AI 初稿 vs 現在）をトグルで切替  
  - `review_comment` は 1000 文字上限。高リスク (risk_flag=Y) のとき必須。  
* **アクションフロー**：保存→承認依頼（submit）→承認結果をタイムライン表示。submit 時に `/api/drafts/{id}/submit` を呼び出し、レスポンスの `approval_status` をそのまま UI に反映。
* **通知**：保存・承認依頼完了時に画面右上トーストを表示、監査ログ ID を併記してコピー可とする。

#### 3.5.9 画面コンポーネントおよびエンドポイント整理
| UIモジュール | Next.js ルート | 主コンポーネント | 呼び出す API | 備考 |
| -- | -- | -- | -- | -- |
| ドラフトボード | `/drafts` | `DraftWorklist`, `DraftDetailPane` | `GET /api/drafts/pending`, `GET /api/drafts/{notice_id}` | 左カラムで絞り込み、選択状態をURLクエリに反映 |
| 編集フォーム | `/drafts` | `DraftEditor` | `POST /api/drafts/{notice_id}/save` | AI 出力と diff で上下 2 段表示 |
| 承認依頼ボタン | `/drafts` | `DraftSubmitBar` | `POST /api/drafts/{draft_id}/submit` | 送信後 `approval_status=pending` を表示 |
| リスクチップ | `/drafts` | `RiskBadge` | - （draft data） | flag=Y で赤、N で青 |

*UI では保存成功後に `mutate` で一覧＋詳細を再取得し、バージョン番号を更新する。*

---

### 3.6 機能名称：F-006 リスク判定ロジック

#### 3.6.1 対応プロセス
* P-005（高リスク案件の判定）

#### 3.6.2 利用者
* 部門：内部処理
* ロール：自動判定エンジン

#### 3.6.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | CA イベント属性 | F-002 | JSON | 金額、イベント種別 |
| 入力 | 過去アラート情報 | Audit DB | JSON | 類似案件フラグ |
| 出力 | リスク判定結果 | F-005 | JSON | risk_flag、理由コード |

#### 3.6.4 画面仕様
* UI なし（結果は UI-CA-003 に表示）

#### 3.6.5 外部システム連携
* なし

#### 3.6.6 業務ルール
* 金額閾値、イベント種別（TOB 等）、過去誤り履歴でスコアリング。
* スコア 70 以上：自動的に高リスク。
* スコア 50〜69：担当者選択次第でフラグ変更可。

#### 3.6.7 例外処理
* 判定に必要なデータ欠落時は「判定保留」とし、UI に警告表示。

---

### 3.7 機能名称：F-007 上長承認ワークフロー連携

#### 3.7.1 対応プロセス
* P-006（上長／品質最終確認）

#### 3.7.2 利用者
* 部門：品質管理、チームリーダー
* ロール：承認者／差戻し対応者

#### 3.7.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | 承認依頼データ | F-005 | JSON | リスクフラグ、修正履歴付 |
| 出力 | 承認ステータス更新 | F-005 | JSON | approved/rejected |
| 出力 | コメント／差戻し理由 | F-005 | text | 必須入力 |

#### 3.7.4 画面仕様
* **画面ID**：UI-CA-004
* 項目：案件一覧（フィルタ付）、AI 生成結果、修正履歴、リスク評価、承認ボタン、差戻しコメント欄。
* アクション：承認、差戻し、再承認依頼、PDF プレビュー。
* エラー：ERR-201「差戻し時はコメント必須」等。

#### 3.7.5 外部システム連携
* 既存ワークフローシステムがあれば API 連携を想定（IF-005：S-004 ワークフロー、REST、双方向、随時）※要件確定時に追記。

#### 3.7.6 業務ルール
* 高リスク案件は承認完了まで通知配信不可。
* 承認期限超過（24h）でリマインドメール送信。

#### 3.7.7 例外処理
* 承認者不在時：代理承認ルールに従い自動リダイレクト。
* 差戻し後に更新がない場合は担当者に再通知。

#### 3.7.8 承認 UI（frontend/app/approvals）追加要件
* **承認待ちダッシュボード**：カードで「本日期限」「期限超過」「高リスク」件数を表示。テーブル列＝ドラフトID、銘柄、リスク、最終更新、担当者。
* **詳細ビュー**：右側に AI 要約／ドラフト本文／修正履歴をタブ表示。承認入力欄には `decision`（approved/rejected）ボタン＋ `comment` テキストエリア（差戻し必須、承認は任意）。`approver_id` はログインユーザー ID を自動セットし編集不可。
* **操作ルール**：  
  - `decision=approved` で `distribution` タブをアンロック  
  - `decision=rejected` 時はコメント 50 文字以上必須、未満の場合 ERR-202  
  - 承認結果送信後はドラフトステータスを即時リロードし、監査ログタイムラインに追記
* **通知連携**：承認完了でドラフト担当者へ通知（メール/API）。本 PoC では画面内に「承認完了（担当者へ通知しました）」トーストを表示。

#### 3.7.9 画面コンポーネントおよびエンドポイント整理
| UIモジュール | Next.js ルート | 主コンポーネント | 呼び出す API | 備考 |
| -- | -- | -- | -- | -- |
| 承認ダッシュボード | `/approvals` | `ApprovalSummaryCards`, `ApprovalQueueTable` | `GET /api/drafts/pending`, `GET /api/drafts/{notice_id}` | pending の中から approver に割当済みのもののみ表示 |
| 承認フォーム | `/approvals` | `ApprovalDecisionPanel` | `POST /api/approvals/{draft_id}` | `decision`, `comment`, `approver_id` を送信 |
| 承認履歴タブ | `/approvals` | `ApprovalTimeline` | `GET /api/approvals/{draft_id}` | 履歴を時系列で表示 |
| 配信準備タブ | `/approvals` | `DistributionLogList` | `GET /api/distribution/{draft_id}`, `POST /api/distribution/{draft_id}` | 承認済みのみ送信ボタン活性化 |

*差戻し（rejected）時は `comment` を 50〜2000 文字に制約し、満たさない場合は送信ボタンを disabled にする。*

---

### 3.8 機能名称：F-008 通知配信システム連携 API

#### 3.8.1 対応プロセス
* P-007（通知配信システムへ連携）

#### 3.8.2 利用者
* 部門：システム部（配信）
* ロール：API サービス

#### 3.8.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | 確定通知文 | F-006 | PDF/HTML | 承認済みのみ |
| 入力 | 配信指示メタデータ | - | JSON | チャネル、配信日 |
| 出力 | 配信ステータス | - | JSON | success/failed/queued |

#### 3.8.4 画面仕様
* UI なし（P-007 進捗はダッシュボードで閲覧予定）

#### 3.8.5 外部システム連携
| No | システム名 | 連携内容 | IF種別 | 呼び出し方向 | 頻度 | 備考 |
| -- | -- | -- | -- | -- | -- | -- |
| IF-006 | S-003 通知配信システム | 確定文送信／配信結果受領 | REST API + MQ | 双方向 | 随時 | 大量時はバッチ |

#### 3.8.6 業務ルール
* 承認ステータスが approved でない案件は送信不可。
* 配信結果が failed の場合は最大 2 回再送、以降は担当者にアラート。

#### 3.8.7 例外処理
* S-003 停止時はキューに蓄積し、再開後自動送信。
* 配信チャネル別エラーは詳細コードを記録し、原因分析に利用。

---

### 3.9 機能名称：F-009 監査ログ／バージョン管理

#### 3.9.1 対応プロセス
* 全体（P-001〜P-007 の横断機能）

#### 3.9.2 利用者
* 部門：コンプライアンス、内部監査、システム管理者
* ロール：監査閲覧、運用保守

#### 3.9.3 入出力仕様
| 種別 | 名称 | 元データ | 形式 | 備考 |
| -- | -- | -- | -- | -- |
| 入力 | 各機能の操作イベント | - | JSON | user_id, action, payload digest |
| 入力 | AI 出力バージョン | F-004/5 | JSON | 生成文ハッシュ含む |
| 出力 | 監査ログレコード | F-009 | DB/CSV | 期間抽出可能 |

#### 3.9.4 画面仕様
* 管理者向けログ閲覧 UI（UI-CA-ADM）を別途提供予定。フィルタ・エクスポート・証跡検索を搭載。

#### 3.9.5 外部システム連携
* SIEM 等へ Syslog 送信（IF-007：セキュリティ監視、Syslog/TCP、One-way、リアルタイム）

#### 3.9.6 業務ルール
* ログは改ざん防止のため Write Once Storage に 7 年保管。
* バージョン番号と承認ステータスは整合性チェック（approved 版のみ配信）。

#### 3.9.7 例外処理
* ログ書き込み失敗時は即時リトライし、失敗継続時はアラートを発火。
* 保存領域逼迫時は自動ローテーションし、古いログをオフライン保管。


